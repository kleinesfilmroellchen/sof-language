<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Language internals - SOF Programming Language Documentation</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../Home.html">Home</a></li><li class="chapter-item expanded "><a href="../Introduction.html"><strong aria-hidden="true">1.</strong> Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Introduction/Stack.html"><strong aria-hidden="true">1.1.</strong> The Stack</a></li><li class="chapter-item expanded "><a href="../Introduction/Names-Errors.html"><strong aria-hidden="true">1.2.</strong> Names and Errors</a></li><li class="chapter-item expanded "><a href="../Introduction/Functions.html"><strong aria-hidden="true">1.3.</strong> Functions</a></li></ol></li><li class="chapter-item expanded "><a href="../Reference.html"><strong aria-hidden="true">2.</strong> Reference</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Reference/Language-Specification.html"><strong aria-hidden="true">2.1.</strong> Language specification</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Reference/Types.html"><strong aria-hidden="true">2.1.1.</strong> Types</a></li><li class="chapter-item expanded "><a href="../Reference/PTs.html"><strong aria-hidden="true">2.1.2.</strong> Primitive Tokens</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Reference/PTs/Arithmetic-Logic.html"><strong aria-hidden="true">2.1.2.1.</strong> Arithmetic</a></li><li class="chapter-item expanded "><a href="../Reference/PTs/Control-flow.html"><strong aria-hidden="true">2.1.2.2.</strong> Control flow</a></li><li class="chapter-item expanded "><a href="../Reference/PTs/Stack.html"><strong aria-hidden="true">2.1.2.3.</strong> Stack &amp; Naming</a></li><li class="chapter-item expanded "><a href="../Reference/PTs/Functional.html"><strong aria-hidden="true">2.1.2.4.</strong> Functional</a></li><li class="chapter-item expanded "><a href="../Reference/PTs/Typing.html"><strong aria-hidden="true">2.1.2.5.</strong> Typing</a></li><li class="chapter-item expanded "><a href="../Reference/PTs/Modules.html"><strong aria-hidden="true">2.1.2.6.</strong> Modules</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../Reference/Builtin-functions.html"><strong aria-hidden="true">2.2.</strong> Built-in functions</a></li><li class="chapter-item expanded "><a href="../Reference/Module-System.html"><strong aria-hidden="true">2.3.</strong> Module system</a></li><li class="chapter-item expanded "><a href="../Reference/Standard-Library.html"><strong aria-hidden="true">2.4.</strong> Standard library</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Reference/Standard-Library/math.html"><strong aria-hidden="true">2.4.1.</strong> math</a></li><li class="chapter-item expanded "><a href="../Reference/Standard-Library/list.html"><strong aria-hidden="true">2.4.2.</strong> list</a></li></ol></li><li class="chapter-item expanded "><a href="../Reference/Language-Internals.html" class="active"><strong aria-hidden="true">2.5.</strong> Language internals</a></li></ol></li><li class="chapter-item expanded "><a href="../Programming-conventions.html"><strong aria-hidden="true">3.</strong> Programming conventions</a></li><li class="chapter-item expanded "><a href="../Glossary.html"><strong aria-hidden="true">4.</strong> Glossary</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">SOF Programming Language Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="how-does-sof-actually-work"><a class="header" href="#how-does-sof-actually-work">How does SOF actually work?</a></h1>
<p>This page shall describe the way that SOF works internally, while staying language-independent, as to accomodate other implementations of SOF compilers and interpreters. Nevertheless, Examples of the reference Java implementation shall be given, as it currently is the only existing implementation of SOF.</p>
<h2 id="data-structures"><a class="header" href="#data-structures">Data Structures</a></h2>
<p>SOF is a pure stack-based language. That means: All data always resides on the Stack, a linear unit of memory cells that contain data. Although we know a stack as being only LIFO and having one single visible element (the top, head or first element of the stack), in practice the SOF stack should be a <strong>Deque</strong>. If it wasn't, one would need two independent stacks for many operations (but both of them could be real, pure stacks).</p>
<p>But what is a Deque? This term, pronounced &quot;deck&quot;, is short for &quot;double ended queue&quot; and describes a data structure with arbitrary access on both ends. The top of the deque is accessed with peek, pop and push, while the bottom of the deque is accessed with peekLast, popLast, pushLast. Java provides not only a Deque in its Collection framework, but also many specialized implementations, such as the currently used <code>ConcurrentLinkedDeque</code>, which is a double-linked-list implementation with threadsafety.</p>
<p>All data lives on the stack, this was already stated. But how does this allow for named variables, namespaces and function calling? The answer is the second most important data structure of SOF, the <strong>Nametable</strong>.</p>
<p>A Nametable is simply a list of key-value mappings (<code>Map</code> in Java and JavaScript, <code>dict</code> in python) that maps identifiers to any SOF data. Pretty simple, but this powers all of SOF. All defintions made by <code>def</code> are simply entries into nametables, the Call operator <code>.</code> simply accesses entries in nametables.</p>
<h3 id="the-global-nametable"><a class="header" href="#the-global-nametable">The Global Nametable</a></h3>
<p>The global nametable (GNT) is always the lowest element on the stack; when it is missing, something serious has gone wrong. The SOF programmer can never inspect, modify or remove the GNT, but it is being used all the time:</p>
<ul>
<li>All defintions made on a global level enter the GNT</li>
<li>All imported NNTs (see below) are placed in the GNT</li>
</ul>
<p>The GNT will be discussed in further detail with its use cases.</p>
<h2 id="scoping-the-call-and-def-operators"><a class="header" href="#scoping-the-call-and-def-operators">Scoping, the Call and Def operators</a></h2>
<p>A Scope is created whenever a function starts. The scope is signaled by a special NT on the stack, called a function delimiter (FD). FDs hold special information on where to return execution when the function ends and what the return value is. Also, the FD cannot be taken off the stack by the program in any other way than returning from executing the current code block or function.</p>
<p>As FDs are NTs, this means that at any point in the program there could be many NTs on the stack at once. To figure out which NT is to be used for the call operator <code>.</code> with an Identifier, the following simple rule is applied: <strong>Walk down the stack from top (last) to bottom (first). Whenever a Nametable is encountered, determine whether it contains the identifier that <code>.</code> wants to call. If so, retrieve this identifier's value from this Nametable, if not, continue the search all the way to the NNT/GNT. If nothing is found, throw a NameError</strong>. This ensures that definitions made in a &quot;more local&quot; NT are more important and hide those in a &quot;more global&quot; NT.</p>
<p>Normally, <code>def</code> operates on the <strong>Local Nametable</strong> (LNT), which is simply the highest NT on the stack. This may be an FD, or the GNT if there is no FD. This importantly means that <strong>code inside a function cannot modify nametables outside unless using the <code>globaldef</code> operator</strong>:</p>
<p>Sometimes, the user wants to define into the GNT. For this, the operator <code>globaldef</code> is provided, which exhibits the same behavior as <code>def</code> except for always defining into the GNT. This is useful for defining functions in an enclosed scope, modifying global variables and so on. It is also convention to always <code>globaldef</code> global functions, constructors, etc.</p>
<h2 id="native-calls"><a class="header" href="#native-calls">Native calls</a></h2>
<p>The PT <code>nativecall</code> executes a call to a natively implemented function. The only explicit argument of the native call is a string identifying the native function to call. Because the reference implementation is Java-based, the way in which native functions are identified is very similar to Java method signatures. The general form is <code>NativeFunction = Package { &quot;.&quot; Package } &quot;.&quot; Class &quot;#&quot; Method &quot;(&quot; [ ArgumentType ] { &quot;,&quot; ArgumentType } &quot;)&quot;</code>, where Package represents a legal Java package name, Class represents a legal Java class name and Method represents a legal Java method name. The argument types must be the internal SOF type names that the reference implementation uses, like StringPrimitive, FloatPrimitive etc. There may be any number of arguments separated by a comma (but no spaces!), and possibly none. The arguments are taken from the stack when <code>nativecall</code> runs, where the last argument taken from the stack is the first argument passed to the native function. The native function may return an SOF typed result, in which case it is placed on the stack, or it may return nothing (void), in which case the stack is not modified. Native functions may throw (incomplete) compiler exceptions, in which case they propagate from the <code>nativecall</code> as normal SOF errors of type <code>Native</code>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../Reference/Standard-Library/list.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../Programming-conventions.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../Reference/Standard-Library/list.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../Programming-conventions.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
